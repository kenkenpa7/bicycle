// --- HTML要素の取得 ---
const startContainer = document.getElementById('start-container');
const quizContainer = document.getElementById('quiz-container');
const resultContainer = document.getElementById('result-container');
const questionNumberEl = document.getElementById('question-number');
const questionTextEl = document.getElementById('question-text');
const optionsContainerEl = document.getElementById('options-container');
const feedbackAreaEl = document.getElementById('feedback-area');
const nextBtn = document.getElementById('next-btn');
const scoreTextEl = document.getElementById('score-text');
const resultMessageEl = document.getElementById('result-message');
const beginnerBtn = document.getElementById('beginner-btn');
const intermediateBtn = document.getElementById('intermediate-btn');
const restartBtn = document.getElementById('restart-btn');
const progressBar = document.getElementById('progress-bar'); // ★これを追記

// --- 効果音の読み込み ---
const correctSound = new Audio('correct.mp3');
const incorrectSound = new Audio('incorrect.mp3');

// --- クイズデータ ---

// 初級編データ
const quizDataBeginner = [
    // ... (前回答で作成した初心者向け30問のデータをここに貼り付け) ...
    // 例:
    {
        question: "道路交通法では、自転車は何という車両に分類されるか？",
        options: ["原動機付自転車", "自動二輪車", "軽車両", "歩行者"],
        answer: 2,
        explanation: "正解は「軽車両」です。自転車はエンジンが付いていませんが、法律上は車の一種（軽車両）として扱われます。そのため、歩道と車道の区別がある場所では、原則として車道を通行しなければなりません。"
    },
    // ... (残り29問) ...
  {
        question: "自転車で夜間にライトをつけずに走ると、法律違反になるか？",
        options: ["違反にならない", "違反になる", "街灯があれば違反にならない", "努力義務なので違反にはならない"],
        answer: 1,
        explanation: "正解は「違反になる」です。夜間（日没から日の出まで）は、前方のライト（前照灯）を点灯し、後方には赤い反射器材（リフレクター）か尾灯を備える義務があります。これは自分の存在を車や歩行者に知らせ、事故を防ぐための重要なルールです。"
    },
    {
        question: "自転車の安全点検の合言葉「ブタベルサハシ」。この「ブ」は何の点検を指すか？",
        options: ["部品（パーツ）", "ブレーキ", "部分的な汚れ", "ブランド"],
        answer: 1,
        explanation: "正解は「ブレーキ」です。これは安全な乗車のための簡単な点検項目を覚えるための語呂合わせです。<br><br><strong>【用語解説】</strong><br><strong>ブ</strong>: ブレーキ（しっかり効くか）<br><strong>タ</strong>: タイヤ（空気が入っているか）<br><strong>ベル</strong>: ベル（ちゃんと鳴るか）<br><strong>サ</strong>: サドル（グラグラしないか）<br><strong>ハ</strong>: ハンドル（しっかり固定されているか）<br><strong>シ</strong>: 車体・チェーンなど（異常はないか）"
    },
    {
        question: "「安全な自転車」の目印として、対人賠償保険が付いているマークはどれか？",
        options: ["JISマーク", "BAAマーク", "SGマーク", "リサイクルマーク"],
        answer: 2,
        explanation: "正解は「SGマーク」です。このマークが付いた製品の欠陥でケガをした場合、保険金が支払われます。自転車本体の他、ヘルメットや幼児用座席にも付いています。<br><br><strong>【用語解説】</strong><br><strong>JISマーク</strong>: 国が定めた品質基準をクリアした製品の証。<br><strong>BAAマーク</strong>: 業界が定めた、より厳しい安全基準の証。<br><strong>SGマーク</strong>: 製品の欠陥による事故に備える保険付きの安全マーク。"
    },

    // --- STEP 2: 自転車の主要な部分の名前と役割 ---
    {
        question: "自転車の骨格となる、三角形を組み合わせたような本体部分を何と呼ぶか？",
        options: ["シャーシ", "ボディ", "フレーム", "ユニット"],
        answer: 2,
        explanation: "正解は「フレーム」です。フレームは自転車の乗り心地や性能を決める最も重要な土台となる部分です。人間でいえば骨格にあたります。"
    },
    {
        question: "ペダルを漕ぐと回転する、歯車が付いた棒状の部品を何と呼ぶか？",
        options: ["クランク", "シャフト", "アーム", "ディレイラー"],
        answer: 0,
        explanation: "正解は「クランク」です。ペダルはクランクの先端に取り付けられています。皆さんが足で回しているのは、このクランクという部品です。この回転がチェーンを動かし、後輪に力が伝わります。"
    },
    {
        question: "クランクの回転軸で、フレームの中心下部にあり、ペダルをスムーズに回すための部品は何か？",
        options: ["ハブ", "ヘッドパーツ", "ボトムブラケット (BB)", "シートポスト"],
        answer: 2,
        explanation: "正解は「ボトムブラケット (BB)」です。BBは『縁の下の力持ち』のような存在で、フレームに隠れて見えにくいですが、ペダルからの力を受け止める非常に重要な回転部品です。"
    },
    {
        question: "ギアチェンジ（変速）を行うために、チェーンを歯車から歯車へ移動させる装置を何というか？",
        options: ["シフター", "ディレイラー", "スプロケット", "ブレーキレバー"],
        answer: 1,
        explanation: "正解は「ディレイラー」です。手元の変速レバー（シフター）を操作すると、このディレイラーが動いてチェーンを掛け替え、ペダルの重さを変えることができます。"
    },
    {
        question: "ハンドルの根元にあり、ハンドルと前輪フォークを繋ぎ、スムーズなハンドル操作を可能にする回転部品は何か？",
        options: ["ヘッドパーツ", "ステム", "ハブ", "BB"],
        answer: 0,
        explanation: "正解は「ヘッドパーツ」です。ヘッドパーツは、フレームと前輪を繋ぐフォークの間にあり、ベアリングによって滑らかなハンドル操作を実現します。ここにガタがあると、走行が不安定になり危険です。"
    },
    {
        question: "ホイールの中心部分で、車軸（シャフト）とスポークを繋ぐ部品を何というか？",
        options: ["リム", "ニップル", "ハブ", "アクスル"],
        answer: 2,
        explanation: "正解は「ハブ」です。ホイール（車輪）は、外側の輪っかである「リム」、中心の回転軸である「ハブ」、そして両者を繋ぐ針金状の「スポーク」の3つで主に構成されています。"
    },

    // --- STEP 3: タイヤとブレーキの基本 ---
    {
        question: "スポーツバイクでよく使われる、細くて先端のネジを緩めてから空気を入れるバルブの形式は何か？",
        options: ["英式バルブ", "米式バルブ", "仏式バルブ", "独式バルブ"],
        answer: 2,
        explanation: "正解は「仏式バルブ」です。高圧の空気を入れやすいのが特徴です。<br><br><strong>【用語解説】</strong><br><strong>英式バルブ</strong>: 一般的なママチャリに使われるお馴染みの形式。<br><strong>米式バルブ</strong>: 自動車と同じで頑丈。MTBなどによく使われます。"
    },
    {
        question: "タイヤの側面に書かれている「700×25C」や「26×1.75」といった表記が表しているものは何か？",
        options: ["タイヤの製造年月日", "タイヤの価格", "タイヤのサイズ（外径と太さ）", "タイヤの推奨空気圧"],
        answer: 2,
        explanation: "正解は「タイヤのサイズ」です。これらの表記はタイヤの交換やチューブの選択時に必須の情報です。例えば「700×25C」は、外径が約700mmで太さが25mmのタイヤであることを示します。"
    },
    {
        question: "タイヤの互換性を確認する上で最も正確な国際規格のサイズ表記はどれか？",
        options: ["インチ表記 (例: 26x1.75)", "フランス式表記 (例: 700x25C)", "ETRTO表記 (例: 25-622)", "TPI表記 (例: 120 TPI)"],
        answer: 2,
        explanation: "正解は「ETRTO（エトルト）表記」です。「25-622」のように「タイヤ幅-リムの直径」で示されます。インチやフランス式は同じ呼び名でも微妙にサイズが違うことがあるため、ETRTOが最も確実な互換性の基準となります。"
    },
    {
        question: "ロードバイクなどで一般的な、車輪のリムを両側から挟んで制動するブレーキを何というか？",
        options: ["ディスクブレーキ", "キャリパーブレーキ", "Vブレーキ", "ドラムブレーキ"],
        answer: 1,
        explanation: "正解は「キャリパーブレーキ」です。構造がシンプルで軽量なのが特徴です。<br><br><strong>【用語解説】</strong><br><strong>Vブレーキ</strong>: クロスバイク等に多く、非常に制動力が高い。<br><strong>ディスクブレーキ</strong>: 車輪の中心にある円盤を挟む方式。天候に左右されにくい。"
    },
    {
        question: "ブレーキの音鳴りを防ぐために、ブレーキシューを進行方向に対して少し斜めに取り付ける調整を何というか？",
        options: ["トーイン調整", "キャンバー調整", "クリアランス調整", "ストローク調整"],
        answer: 0,
        explanation: "正解は「トーイン調整」です。ブレーキシュー全体が一度にリムに当たると「キーッ」と共振音が出やすいため、あえてシューの前方がわずかに早く当たるように角度をつけます。これにより音鳴りを防ぎ、ブレーキの効き方もスムーズになります。"
    },

    // --- STEP 4: 少し専門的な知識（規格・材質） ---
    {
        question: "JIS(BSC)規格のボトムブラケットで、右側（チェーン側）のねじが「逆ネジ」になっている主な理由は何か？",
        options: ["左右を間違えないようにするため", "製造上の都合", "ペダルを漕ぐ力で緩むのを防ぐため", "イタリアの規格と区別するため"],
        answer: 2,
        explanation: "正解は「ペダルを漕ぐ力で緩むのを防ぐため」です。ペダルを漕ぐと、BB内部の摩擦で右側の部品には時計回り（正ネジだと緩む方向）の力がかかります。そこで、あえて逆ネジにすることで、走行中に自然と締まる方向に力がかかるように工夫されています。"
    },
    {
        question: "自転車のフレーム素材として使われる「クロモリ」とは、何の略称か？",
        options: ["クロム・モリブデン鋼", "クロス・モーター・バイク", "カーボン・モノコック", "クローム・メッキ"],
        answer: 0,
        explanation: "正解は「クロム・モリブデン鋼」。鉄にクロムとモリブデンを混ぜた合金です。細身でしなやかな乗り心地が特徴ですが、アルミやカーボンに比べると重く、錆びやすい性質があります。"
    },
    {
        question: "軽量で設計の自由度が高い一方、強い衝撃で割れることがあるため、締め付けトルク管理が非常に重要なフレーム素材は何か？",
        options: ["クロモリ鋼", "アルミニウム合金", "チタン合金", "カーボンファイバー"],
        answer: 3,
        explanation: "正解は「カーボンファイバー」。炭素繊維を樹脂で固めた複合素材です。非常に軽量で、好きな形に作りやすい反面、金属のように凹むのではなく「パキッ」と割れることがあるため、ネジを締めすぎないよう専用工具（トルクレンチ）での管理が必須です。"
    },
    {
        question: "チェーンが伸びる」という現象の正しい説明はどれか？",
        options: ["チェーンの金属プレート自体が伸びる", "チェーンのピンとローラーの隙間が摩耗で広がる", "使用によりチェーンが磁化して長くなる", "熱でチェーンが膨張する"],
        answer: 1,
        explanation: "正解は選択肢2です。チェーンは使っているうちに、部品同士がこすれて少しずつ削れていきます。その結果、ピンとローラーの間にガタ（隙間）ができて、全体として長くなったように見えるのが「伸び」の正体です。伸びたチェーンは歯車を傷めるので定期的な交換が必要です。"
    },
    {
        question: "ホイールを組む際、スポークを放射状にまっすぐ張る組み方を何というか？",
        options: ["タンジェント組（クロス組）", "ラジアル組", "イタリアン組", "JIS組"],
        answer: 1,
        explanation: "正解は「ラジアル組」です。見た目がスッキリして軽量ですが、ねじれの力に弱いという特徴があります。そのため、ペダルを漕ぐ力（駆動トルク）がかからない、リムブレーキの前輪などに主に使われます。"
    },

    // --- STEP 5: 工具と整備の知識 ---
    {
        question: "ネジを指定された強さ（トルク）で正確に締めるために使う、整備に不可欠な工具は何か？",
        options: ["モンキーレンチ", "トルクレンチ", "プライヤー", "スパナ"],
        answer: 1,
        explanation: "正解は「トルクレンチ」です。特にカーボンパーツなどデリケートな部品は、締めすぎると破損し、緩すぎると走行中に外れる危険があります。そのため、メーカーが指定した「締め付けトルク（強さ）」を守るためにこの工具が必須となります。"
    },
    {
        question: "クランクをBB（ボトムブラケット）の軸から安全に取り外すために使用する専用工具は何か？",
        options: ["チェーンカッター", "ペダルレンチ", "コッタレスクランク抜き", "ワイヤーカッター"],
        answer: 2,
        explanation: "正解は「コッタレスクランク抜き」です。クランクはBB軸に非常に固く圧入されているため、手で引き抜くことはできません。この工具は、てこの原理を応用して、部品を傷つけずに安全にクランクを押し出すことができます。"
    },
    {
        question: "ワイヤーの先端がバラバラにほつれるのを防ぐために被せる、小さな金属製のキャップを何と呼ぶか？",
        options: ["ニップル", "エンドキャップ", "フェルール", "グロメット"],
        answer: 1,
        explanation: "正解は「エンドキャップ」です。<br><br><strong>【用語解説】</strong><br><strong>エンドキャップ</strong>: インナーワイヤー（内側の細いワイヤー）の先端に被せる。<br><strong>フェルール</strong>: アウターケーブル（外側の太いチューブ）の末端に付けるキャップ。"
    },
    {
        question: "ペダルの取り付けネジに関する正しい説明はどれか？",
        options: ["左右どちらも、時計回りで締まる", "左右どちらも、反時計回りで締まる", "右ペダルは時計回り、左ペダルは反時計回りで締まる", "右ペダルは反時計回り、左ペダルは時計回りで締まる"],
        answer: 2,
        explanation: "正解は選択肢3です。左ペダルは通常とは逆の「逆ネジ」になっています。これは、ペダルを漕いでいるうちに緩んでしまわないようにするための工夫です。進行方向に向かって回すと締まる、と覚えると分かりやすいです。"
    },
    {
        question: "油圧ディスクブレーキのオイルラインに入り込んだ空気を抜き、新しいオイルを充填する作業を何というか？",
        options: ["ブリーディング", "フェイシング", "タッピング", "グリスアップ"],
        answer: 0,
        explanation: "正解は「ブリーディング」です。ブレーキラインに空気が混入すると、レバーがフカフカになりブレーキが効かなくなって非常に危険です。この作業は、注射器のような専用工具を使ってオイルを交換し、空気を完全に追い出す重要なメンテナンスです。"
    },

    // --- STEP 6: 応用知識 ---
    {
        question: "自転車がまっすぐ走ろうとする性質（直進安定性）に最も大きく関わる、フレームの設計値を何というか？",
        options: ["シート角", "トレール量", "Qファクター", "スタンドオーバーハイト"],
        answer: 1,
        explanation: "正解は「トレール量」です。これは前輪の接地点と、ハンドルの回転軸の延長線が地面と交わる点との距離を指します。この距離が大きいほど、自然とハンドルが直進方向に戻ろうとする力が働き、自転車は安定します。乗り心地を決める重要な設計値の一つです。"
    },
    {
        question: "「7分組」の自転車を店舗で組み立てる際、通常は『行わない』作業はどれか？",
        options: ["ホイールの振れ取り調整", "ブレーキや変速機の調整", "フレームへのヘッドパーツの圧入", "ハンドルやペダルの取り付け"],
        answer: 2,
        explanation: "正解は「フレームへのヘッドパーツの圧入」です。「7分組」とは、工場である程度組み立てられた状態の自転車を指します。フレームにヘッドパーツやBBを圧入するような大掛かりな作業は工場で済んでおり、販売店では最終的な組み立てと精密な調整を行います。"
    },
    {
        question: "「カップアンドコーン式ベアリング」の最大の特徴は何か？",
        options: ["完全に密閉されており、メンテナンス不要である", "分解して清掃や玉当たりの微調整が可能である", "セラミック製で非常に高価である", "針状のローラーを使用している"],
        answer: 1,
        explanation: "正解は選択肢2です。この形式は、お椀状の受け皿（カップ）と円錐状の部品（コーン）で鋼球（ボール）を挟み込む古典的な構造です。分解できるため、グリスを入れ替えたり、締め付け具合（玉当たり）を調整して回転のスムーズさを最適化できるのが大きな利点です。"
    },
    {
        question: "自転車のサドルの高さを合わせる際の、一般的な目安はどれか？",
        options: ["両足のつま先が、地面にしっかり着く高さ", "サドルにまたがり、ペダルが一番下に来た時に膝が完全に伸びきる高さ", "サドルにまたがり、ペダルが一番下に来た時に膝がわずかに曲がる高さ", "サドルの高さとハンドルの高さを同じにする"],
        answer: 2,
        explanation: "正解は選択肢3です。ペダルが一番下（6時の位置）にあるときに、膝が軽く曲がる程度が、最も効率よく力を伝えられ、膝への負担も少ない高さとされています。膝が伸びきったり、逆に曲がりすぎたりするのは良くありません。"
    },
    {
        question: "カーボンフレームとアルミ製のシートポストのように、異なる種類の金属（または導電体）が接触する際に注意すべき現象は何か？",
        options: ["熱膨張による固着", "異種金属接触腐食（電食）", "静電気による帯電", "金属疲労の促進"],
        answer: 1,
        explanation: "正解は「異種金属接触腐食（電食）」です。性質の異なる金属が水分を介して接触すると、電池のように微弱な電流が流れ、片方の金属（イオン化傾向の大きいアルミなど）が錆びてボロボロになってしまいます。これを防ぐため、組み立て時に専用のコンパウンド（グリス）を塗布して絶縁する必要があります。"
    }
];

// 中級編データ (より専門的な内容)
const quizDataIntermediate = [
    {
        question: "道路交通法施行規則が定める「普通自転車」の車体の大きさの基準として正しいものはどれか。",
        options: ["長さ190cm以下、幅60cm以下", "長さ180cm以下、幅60cm以下", "長さ190cm以下、幅50cm以下", "長さ200cm以下、幅70cm以下"],
        answer: 0,
        explanation: "正解は「長さ190cm以下、幅60cm以下」。この具体的な数値は、歩道通行の例外規定が適用される自転車の条件として頻出です。"
    },
    {
        question: "JIS規格のボトムブラケット（BB）で、右ワン（ドライブ側）が逆ネジである主な理由はどれか。",
        options: ["製造コスト削減のため", "ペダリングによる緩みを防ぐため", "イタリアン規格と差別化するため", "左右の区別を容易にするため"],
        answer: 1,
        explanation: "正解は「ペダリングによる緩みを防ぐため」。ペダリング時の摩擦力が右ワンを時計回り（正ネジだと緩む方向）に回転させようとするため、逆ネジにすることで自然に締まるように設計されています。"
    },
    {
        question: "フレームジオメトリーにおいて、キャスター角が寝る（角度が小さい）と、トレール量はどう変化し、走行安定性はどうなるか。",
        options: ["トレール量は小さくなり、安定性は低下する", "トレール量は大きくなり、安定性は向上する", "トレール量は大きくなり、安定性は低下する", "トレール量は変化せず、安定性も変わらない"],
        answer: 1,
        explanation: "正解は「トレール量は大きくなり、安定性は向上する」。トレール量が大きいほど、ハンドルが直進に戻ろうとする力（セルフアライニングトルク）が強くなり、直進安定性が増します。"
    },
    {
        question: "油圧ディスクブレーキに使用されるDOTフルードの最も重要な特性は何か。",
        options: ["非吸湿性であり、メンテナンスフリーである", "吸湿性が高く、定期的な交換が必要である", "ミネラルオイルと互換性がある", "粘度が非常に低く、凍結しにくい"],
        answer: 1,
        explanation: "正解は「吸湿性が高く、定期的な交換が必要である」。DOTフルードは空気中の水分を吸収して劣化し、沸点が低下します。沸点が下がると、激しいブレーキングでオイルが沸騰し（ベーパーロック現象）、ブレーキが効かなくなるため定期交換が必須です。"
    },
    {
        question: "ホイールの後輪やディスクブレーキホイールに必須とされるスポークの組み方はどれか。",
        options: ["ラジアル組", "タンジェント組（クロス組）", "ハーフクロス組", "ヨンヨン組"],
        answer: 1,
        explanation: "正解は「タンジェント組（クロス組）」。スポークを交差させることで、駆動トルクや制動トルクといった「ねじれの力」を効率よく伝達できます。ラジアル組はねじれに弱いため、これらの力がかかるホイールには使用できません。"
    },
    {
        question: "製造物責任法（PL法）における賠償請求権の消滅時効として、正しいものはどれか。",
        options: ["被害者が損害を知った時から1年、または製品の引き渡しから5年", "被害者が損害を知った時から3年、または製品の引き渡しから10年", "被害者が損害を知った時から5年、または製品の引き渡しから10年", "時効はなく、いつでも請求できる"],
        answer: 1,
        explanation: "正解は「被害者が損害を知った時から3年、または製品の引き渡しから10年」。この両方の期間が経過すると、権利は時効によって消滅します。3年と10年という数字を覚えましょう。"
    },
    {
        question: "タイヤの互換性を判断する上で最も信頼性が高い国際規格「ETRTO」表記（例: 25-622）が示すものは何か。",
        options: ["タイヤ外径 - タイヤ幅", "タイヤ幅 - ビード径", "タイヤ内径 - タイヤ外径", "推奨空気圧 - タイヤ幅"],
        answer: 1,
        explanation: "正解は「タイヤ幅(mm) - ビード径(mm)」。ビード径がリムの直径と一致することが互換性の絶対条件です。700Cと29インチは呼び名が違いますが、ETRTOビード径は共に622mmです。"
    },
    {
        question: "Vブレーキに、それに対応していないカンチブレーキ用レバーを組み合わせた場合に起こる現象は何か。",
        options: ["ブレーキの効きが極端に甘くなる", "レバーを少し引いただけでも急激にブレーキが効き、非常に危険である", "レバーが重すぎて引けなくなる", "特に問題なく使用できる"],
        answer: 1,
        explanation: "正解は選択肢2。Vブレーキはてこ比が大きいため、ワイヤーの引き量が大きい専用レバーが必要です。引き量の少ないカンチ用レバーで引くと、過大な制動力でカックンブレーキ状態になり非常に危険です。"
    },
    {
        question: "カーボンフレームとアルミ製シートポストを組付ける際に、異種金属接触腐食を防ぐために塗布すべきものは何か。",
        options: ["通常のグリス", "ネジロック剤", "カーボンアッセンブリーコンパウンド（グリッパーペースト）", "シリコンスプレー"],
        answer: 2,
        explanation: "正解は「カーボンアッセンブリーコンパウンド」。これは微細な粒子を含み、①低いトルクでも滑りを防ぎ、②カーボンと金属の直接接触を防いで電食を防止する、という二つの重要な役割を果たします。"
    },
    {
        question: "チェーンの伸び率を測定し、1%以上の伸びが確認された場合、最も懸念される二次的な損傷は何か。",
        options: ["フレームの破損", "ディレイラーの故障", "スプロケットやチェーンリングの歯の異常摩耗", "BBの破損"],
        answer: 2,
        explanation: "正解は選択肢3。伸びたチェーンは歯車とピッチが合わなくなり、歯の先端に乗り上げて削り取ってしまいます。これを放置すると、チェーン交換だけでは済まなくなり、高価なスプロケットやクランクセット全体の交換が必要になります。"
    },
    // ... ここに中級編の問題をさらに20問追加 ...
    // 以下、中級編の追加問題例
    { question: "道路交通法施行規則が定める、自転車の前照灯が持つべき性能はどれか。", options: ["前方5mの障害物を確認できる光度", "前方10mの障害物を確認できる光度", "前方15mの障害物を確認できる光度", "前方20mの障害物を確認できる光度"], answer: 1, explanation: "正解は「前方10m」。後方の反射器材は「100m」後方から視認できる性能が必要です。10mと100mのセットで覚えましょう。" },
    { question: "タイヤのケーシング密度を示す「TPI」値が高いタイヤの一般的な特徴は何か。", options: ["耐パンク性が高く頑丈", "価格が安価", "しなやかで転がり抵抗が低い", "空気圧の許容範囲が広い"], answer: 2, explanation: "正解は「しなやかで転がり抵抗が低い」。高TPIは細い繊維を高密度で使うため、タイヤがしなやかになり路面追従性が向上します。反面、耐パンク性はやや劣る傾向にあります。" },
    { question: "ねじ切り式BBで、シェル幅70mm、左右共に正ネジなのはどの規格か。", options: ["JIS (BSC) 規格", "イタリアン規格", "フレンチ規格", "スパニッシュ規格"], answer: 1, explanation: "正解は「イタリアン規格」。JIS規格（シェル幅68mm、右ワン逆ネジ）との違いを明確に区別しましょう。" },
    { question: "リアディレイラーのBテンションアジャストボルトの主な役割は何か。", options: ["ワイヤーの張りを微調整する", "ディレイラーの最大可動範囲を決める", "ガイドプーリーとスプロケットの間隔を調整する", "ディレイラーの取り付け角度を調整する"], answer: 2, explanation: "正解は選択肢3。この間隔が適切でないと、スムーズな変速ができません。近すぎるともたつき、離れすぎるとレスポンスが悪化します。" },
    { question: "カップアンドコーン式ベアリングの「玉当たり調整」とは、具体的に何を調整することか。",
      options: ["ベアリングのグリス量", "鋼球（ボール）の数", "ワンとコーンの締め付け具合による、回転の軽さとガタの無さのバランス", "ハブ軸の左右の位置"], answer: 2, explanation: "正解は選択肢3。締めすぎると回転が重くなり、緩すぎるとガタが出ます。その最適なバランス点を見つけるのが玉当たり調整です。" },
    { question: "ペダルの取り付けネジに関する正しい説明はどれか。", options: ["左右とも正ネジ", "左右とも逆ネジ", "右が正ネジ、左が逆ネジ", "右が逆ネジ、左が正ネジ"], answer: 2, explanation: "正解は「右が正ネジ、左が逆ネジ」。進行方向に対して回すと締まるように設計されており、ペダリング中に緩むのを防ぎます。" },
    { question: "7分組の自転車を組み立てる際に、自転車技士が通常『行わない』作業はどれか。", options: ["ホイールの振れ取り", "ヘッドパーツの圧入", "ブレーキ・変速機の調整", "各部ボルトの適正トルクでの締め付け"], answer: 1, explanation: "正解は「ヘッドパーツの圧入」。7分組ではフレームにヘッドパーツやBBは圧入済みの状態で出荷されます。技士の仕事は最終組立と精密な調整です。" },
    { question: "コッタレスクランク抜き工具を使用する対象となるクランクの固定方式はどれか。", options: ["スクエアテーパー式、オクタリンク式など", "ホローテックIIなどのアウトボードBB式", "圧入式のプレスフィットBB", "スルーアクスル式"], answer: 0, explanation: "正解は選択肢1。BBシャフトが四角（スクエア）や八角（オクタリンク）の形状で、クランクを圧入して固定するタイプに使用します。ホローテックIIはクランクとBBシャフトが一体型のため、この工具は使いません。" },
    { question: "青色TSマークが、赤色TSマークに比べて優れている点は何か。", options: ["有効期間が2年間である", "賠償責任保険の補償上限額が高い", "自転車の盗難保険が付帯する", "対物賠償も補償される"], answer: 1, explanation: "正解は「賠償責任保険の補償上限額が高い」。赤色が1000万円程度なのに対し、青色や緑色のTSマークは1億円の賠償責任保険が付帯します（金額は変動の可能性あり）。" },
    { question: "スポークの組み方で、ラジアル組がタンジェント組に比べて劣っている点は何か。", options: ["横剛性", "重量", "見た目の美しさ", "ねじれ剛性（トルク伝達能力）"], answer: 3, explanation: "正解は「ねじれ剛性」。スポークがハブから放射状に伸びるため、駆動やディスクブレーキのねじれ力に耐えられません。そのため後輪やディスクブレーキ車には使われません。" },
    // ここまでで20問、あと10問追加
    { question: "ディスクブレーキローターの固定方式「センターロック」を提唱し、普及させている主要なメーカーはどこか。", options: ["SRAM", "Campagnolo", "SHIMANO", "TRP"], answer: 2, explanation: "正解は「SHIMANO」。専用のロックリング工具で迅速に着脱できるのが特徴です。6ボルト方式はより多くのメーカーが採用しています。" },
    { question: "フレームのヘッドチューブにベアリングカップを介さず、ベアリングを直接はめ込む方式のヘッドパーツ規格を何というか。", options: ["インテグラルヘッド", "インセット（ゼロスタック）ヘッド", "エクスターナルカップヘッド", "スレッドヘッド"], answer: 0, explanation: "正解は「インテグラルヘッド」。フレーム側にあらかじめベアリングを受ける形状が成形されています。軽量化に貢献しますが、フレーム側の精度が非常に重要になります。" },
    { question: "一般的なクイックリリース式のハブにおける、エンド幅の標準的な寸法として、ロードバイクの後輪で正しいものはどれか。", options: ["100mm", "120mm", "130mm", "135mm"], answer: 2, explanation: "正解は「130mm」。ロードバイクは前輪100mm、後輪130mmが標準です。MTBは前輪100mm、後輪135mmが一般的でした（現在はスルーアクスルのブースト規格などが主流）。" },
    { question: "塑性域締め付けで締められたボルトを、分解後に再使用してはならない理由は何か。", options: ["錆びやすくなっているため", "ねじ山が潰れているため", "ボルトが伸びきっており、規定の軸力が出せないため", "熱で硬化しているため"], answer: 2, explanation: "正解は選択肢3。塑性域締め付けは、ボルトをあえて伸ばして元に戻らない領域まで締めることで高い締結力を得ます。一度伸びたボルトは再度同じ性能を発揮できないため、必ず新品に交換する必要があります。" },
    { question: "チューブレスタイヤの利点として、適切でないものはどれか。", options: ["リム打ちパンク（スネークバイト）のリスクがない", "乗り心地がしなやかで、転がり抵抗が低い", "シーラント剤により、小さな穴は自動で塞がる", "チューブがないため、ホイールへの取り付けが非常に簡単である"], answer: 3, explanation: "適切でないのは選択肢4。チューブレスタイヤはリムとの気密性を保つため、ビードが非常に硬く、取り付けにはコツと力が必要な場合が多く、簡単とは言えません。" },
    { question: "サドルのレール（座面裏の2本の棒）の材質として、最も軽量で高価なものはどれか。", options: ["スチール", "クロモリ", "チタン", "カーボンファイバー"], answer: 3, explanation: "正解は「カーボンファイバー」。レールまでカーボン製にすることで、軽量化と振動吸収性の向上を図りますが、非常に高価で取り扱いにも注意が必要です。" },
    { question: "フリーハブボディにスプロケットを固定する際に使う、チェーンが付いた工具の名称は何か。", options: ["スプロケットリムーバー（フリーホイールリムーバー）", "ロックリング回し", "チェーンカッター", "チェーンフッカー"], answer: 0, explanation: "正解は「スプロケットリムーバー」。スプロケットが空転しないように固定するための工具です。これと「ロックリング回し」を組み合わせてスプロケットを着脱します。" },
    { question: "自転車の各部の名称で、フレームの後輪車軸を取り付ける部分を何と呼ぶか。", options: ["シートステー", "チェーンステー", "ドロップアウト（エンド）", "BBシェル"], answer: 2, explanation: "正解は「ドロップアウト（エンド）」。ここにディレイラーハンガーが付いていることも多く、フレームの中でも特に重要な部分です。" },
    { question: "ブレーキレバーやシフトレバーをハンドルバーに固定する部品を何と呼ぶか。", options: ["バンド", "クランプ", "ホルダー", "ブラケット"], answer: 1, explanation: "正解は「クランプ」。締め付けるという意味の言葉で、この部分のボルトを適正トルクで締めることが安全上非常に重要です。" },
    { question: "自転車技士の実技試験で、7分組自転車を組み立てる際に、特に時間配分と精度が問われる作業は何か。", options: ["ペダルの取り付け", "サドルの高さ調整", "ホイールの振れ取り", "チェーンへの注油"], answer: 2, explanation: "正解は「ホイールの振れ取り」。許容範囲内に収める精度と、それに時間をかけすぎない手際の良さの両方が求められる、実技試験の関門の一つです。" }
];

// 初級編のデータを中級編のデータで不足している分、補う（仮）
// 本来は、中級編も30問用意するのがベスト
while(quizDataIntermediate.length < 30) {
    quizDataIntermediate.push({
        question: `(中級問題 ${quizDataIntermediate.length + 1})`,
        options: ["A", "B", "C", "D"],
        answer: 0,
        explanation: "これはダミー問題です。"
    })
}


// --- グローバル変数 ---
let currentQuizData = []; // 現在のレベルのクイズデータを保持
let currentQuestionIndex = 0;
let score = 0;


// --- イベントリスナー ---
beginnerBtn.addEventListener('click', () => {
    startQuiz(quizDataBeginner);
});

intermediateBtn.addEventListener('click', () => {
    startQuiz(quizDataIntermediate);
});

nextBtn.addEventListener('click', () => {
    currentQuestionIndex++;
    if (currentQuestionIndex < currentQuizData.length) {
        loadQuiz();
    } else {
        showResult();
    }
});

restartBtn.addEventListener('click', () => {
    // 結果画面とクイズ画面を非表示にし、スタート画面を表示
    resultContainer.style.display = 'none';
    quizContainer.style.display = 'none';
    startContainer.style.display = 'block';
});


// --- 関数群 ---

/**
 * クイズを開始する関数
 * @param {Array} quizLevelData - 使用するクイズデータ (初級 or 中級)
 */
function startQuiz(quizLevelData) {
    currentQuizData = quizLevelData;
    currentQuestionIndex = 0;
    score = 0;

    // 画面の切り替え
    startContainer.style.display = 'none';
    quizContainer.style.display = 'block';

    loadQuiz();
}

/**
 * 現在の問題を画面に表示する関数
 */
function loadQuiz() {
    feedbackAreaEl.style.display = 'none';
    nextBtn.style.display = 'none';

    const quiz = currentQuizData[currentQuestionIndex];
    
    questionNumberEl.innerText = `問題 ${currentQuestionIndex + 1} / ${currentQuizData.length}`;
    questionTextEl.innerText = quiz.question;
    optionsContainerEl.innerHTML = '';

 // ★ここから追記★
    // プログレスバーの更新
    const progressPercent = ((currentQuestionIndex) / currentQuizData.length) * 100;
    progressBar.style.width = `${progressPercent}%`;
    // ★ここまで追記★

    quiz.options.forEach((option, index) => {
        const button = document.createElement('button');
        // innerHTML を使うことで <br> タグなどを解釈させる
        button.innerHTML = option;
        button.addEventListener('click', () => selectOption(index));
        optionsContainerEl.appendChild(button);
    });
}

/**
 * 選択肢が選ばれたときの処理
 * @param {number} selectedIndex - 選ばれた選択肢のインデックス
 */
function selectOption(selectedIndex) {
    const quiz = currentQuizData[currentQuestionIndex];
    const correctIndex = quiz.answer;
    const allOptions = Array.from(optionsContainerEl.children);

    // まず全てのボタンを無効化
    allOptions.forEach(button => {
        button.disabled = true;
    });

    // プログレスバーを進める
    const progressPercent = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
    progressBar.style.width = `${progressPercent}%`;

    // 正解・不正解の判定とクラスの付与
    if (selectedIndex === correctIndex) {
        // 正解の場合
        score++;
        correctSound.play();
        allOptions[selectedIndex].classList.add('correct'); // 選んだボタンにcorrectクラス
        feedbackAreaEl.innerHTML = `<strong>正解！</strong><br>${quiz.explanation}`;
        feedbackAreaEl.className = 'feedback-area correct';
    } else {
        // 不正解の場合
        incorrectSound.play();
        allOptions[selectedIndex].classList.add('incorrect'); // 選んだボタンにincorrectクラス
        allOptions[correctIndex].classList.add('correct'); // 正解のボタンにcorrectクラス
        feedbackAreaEl.innerHTML = `<strong>不正解...</strong><br>${quiz.explanation}`;
        feedbackAreaEl.className = 'feedback-area incorrect';
    }

    // フィードバックエリアと次へボタンを表示
    feedbackAreaEl.style.display = 'block';
    nextBtn.style.display = 'block';
}

/**
 * 結果を表示する関数
 */
function showResult() {
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    scoreTextEl.innerText = `${currentQuizData.length}問中 ${score}問 正解！`;

    let message = '';
    const percentage = (score / currentQuizData.length) * 100;
    if (percentage === 100) {
        message = '完璧です！全問正解！自信を持って試験に臨んでください！';
    } else if (percentage >= 80) {
        message = '素晴らしい成績です。合格圏内です。間違えた数問を完璧にすれば、もう安心です。';
    } else if (percentage >= 60) {
        message = 'おしい！合格ラインは目前です。特に間違えた分野の解説を重点的に復習しましょう。';
    } else {
        message = '基礎からじっくり復習が必要です。解説を何度も読み返し、知識の土台を固めましょう。';
    }
    resultMessageEl.innerText = message;
}

// 初期状態では何も実行せず、ユーザーの操作を待つ